<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

    <head>
        <title>GUIA</title>
        <meta http-equiv="content-type"
              content="text/html;charset=utf-8" />

        <!-- Include stylesheets -->
        <link href="/css/bootstrap.css" type="text/css" rel="stylesheet" />
        <link href="/css/guia.css" type="text/css" rel="stylesheet" />
        <style type="text/css">
            /* Override some defaults */
            html, body {
                background-color: #eee;
            }

            body {
                padding-top: 40px;
            }

            .container > footer p {
                margin-top: 10px;
                text-align: center; /* center align it with the container */
            }

            /* The white background content wrapper */
            .content {
                background-color: #fff;
                padding: 20px;
                margin: 0 -20px; /* negative indent the amount of the padding to maintain the grid system */
                -webkit-border-radius: 0 0 6px 6px;
                -moz-border-radius: 0 0 6px 6px;
                border-radius: 0 0 6px 6px;
                -webkit-box-shadow: 0 1px 2px rgba(0,0,0,.15);
                -moz-box-shadow: 0 1px 2px rgba(0,0,0,.15);
                box-shadow: 0 1px 2px rgba(0,0,0,.15);
            }

            /* Give a quick and non-cross-browser friendly divider */
            .content .span4 {
                margin-left: 0;
                padding-left: 19px;
                border-left: 1px solid #eee;
            }

            .span-one-third {
                width: 260px;
            }

        </style>
        
        <script type="text/javascript">
            /* <![CDATA[ */
            (function() {
                var s = document.createElement('script');
                var t = document.getElementsByTagName('script')[0];
            
                s.type = 'text/javascript';
                s.async = true;
                s.src = 'https://api.flattr.com/js/0.6/load.js?mode=auto';
            
                t.parentNode.insertBefore(s, t);
             })();
            /* ]]> */
        </script>

        <script type="text/javascript" src="/js/jquery/jquery-1.7.js"></script>
        <script type="text/javascript" src="/js/jquery-plugins/bootstrap.js"></script>
        <script type="text/javascript" src="/js/backbone/underscore.js"></script>
        <script type="text/javascript" src="/js/backbone/backbone.js"></script>

        <script type="text/javascript" src="/js/utils/EventEmitter.js"></script>
        <script type="text/javascript" src="/js/utils/xdate.js"></script>
        <script type="text/javascript" src="/js/utils/sha512.js"></script>

        <script type="text/javascript" src="/socket.io/socket.io.js"></script>
        <script type="text/javascript" src="/i18next/i18next.js"></script>

        <script type="text/javascript" src="/js/bootstrap.js"></script>

        <script type="text/javascript" src="/js/models/EventModel.js"></script>
        <script type="text/javascript" src="/js/collections/EventCollection.js"></script>

        <% files.forEach(function (file) {
            switch (file.type) {
                case 'application/javascript':
        %>
                    <script type="text/javascript" src="<%= file.src %>"></script>
        <%          break;
            }
        }); %>

        <% templates.forEach(function (template) { %>
        <script type="text/template" id="<%= template.id %>">
            <% partial(template.src) %>
        </script>
        <% }); %>
        
        <!-- Start application -->
        <script type="text/javascript">
            $(document).ready(function () {
                var WorkspaceRouter = Backbone.Router.extend({
                    routes: {
                        <% var appRoutes = [];
                        routes.forEach(function (route) {
                            appRoutes.push('\'' + route.path + '\': \'' + route.action + '\'');
                        }); %>
                        <%= appRoutes.join(', ') %>
                    },

                    initialize: function () {
                        this.bind('all', function(ev) {
                            if (ev.indexOf('beforeroute:') === 0) {
                                EventEmitter.global.emit('beforeroute', ev, Backbone.history.fragment);

                                if (this.currentView != null) {
                                    this.currentView.remove();
                                }
                            }
                        });
                    },

                    route: function (route, name, callback) {
                        return Backbone.Router.prototype.route.call(this, route, name, function () {
                            var _this = this;
                            this.trigger.apply(this, ['beforeroute:' + name].concat(_.toArray(arguments)));

                            var self = this;
                            var func_args = arguments;

                            socket.emit('Authentication:loggedIn', function (loggedIn) {
                                if (!loggedIn && (route != '!/' && route != '!/Login' && route != '!/About')) {
                                    route = '!/Login';

                                    _this.navigate(route, true);
                                } else {
                                    callback.apply(self, func_args);
                                }
                            });
                        });
                    },

                    updateNavigation: function (req) {
                        if (req == "") {
                            $('.nav > li.active').removeClass('active');
                            $('.nav > li > a[href="#"]').parent().addClass('active');
                        } else {
                            $('.nav > li.active').removeClass('active');
                            $('.nav > li > a[href="#' + req + '"]').parent().addClass('active');
                        }
                    }

                    <% routes.forEach(function (route) { %>
                    ,<%= route.action %>: function (<% if (route.parameter) {
                        var params = [];
                        route.parameter.forEach(function (parameter) {
                            params.push(parameter.name);
                        }); %>
                        <%= params.join(', ') %>
                    <% } %>) {
                        this.currentView = new <%= route.view %>(<% if (route.parameter) { %>
                            {
                            <%
                            var params = [];
                            route.parameter.forEach(function (parameter) {
                                params.push(parameter.name + ': ' + parameter.name);
                            }); %>
                            <%= params.join(', ') %>
                            }
                        <% } %>);
                        $('#body').html(this.currentView.render().el);
                    }
                    <% }); %>
                });

                var options = {
                    ns: { namespaces: ['<%- locales.join('\', \'') %>'], defaultNs: 'ns.app'},
                    useLocalStorage: false,
                    resGetPath: '/locales/resources.json?lng=__lng__&ns=__ns__',
                    resPostPath: '/locales/add/__lng__/__ns__',
                    dynamicLoad: true,
                    sendMissing: true
                };
                
                $.i18n.init(options, function() {
                    var navigationCollection = new NavigationCollection;
                    var navigationView = new NavigationView({
                        el: $('.navbar'),
                        collection: navigationCollection
                    });

                    navigationView.done(function () {
                        var wsRouter = new WorkspaceRouter();
                        Backbone.history.start({pushState: true});
                    });

                    function setClock() {
                        var now = new Date();
                        $('#clock').text((now.getHours() < 10 ? "0" : "") + now.getHours() + (now.getSeconds() %2 == 0 ? ":" : " ") + (now.getMinutes() < 10 ? "0" : "") + now.getMinutes());
                        setTimeout(setClock, 1000);
                    }

                    setClock();
                });

                $('[data-view="Welcome"]').click(function () {
                    Backbone.history.navigate('!/', true);
                });
            });
        </script>
    </head>

    <body>
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a style="cursor: pointer;" class="brand" data-view=""><%- t('application.name') %></a>

                    <ul class="nav" style="display: none;">
                    </ul>

                    <div id="clock" class="nav secondary-nav" style="margin-right: -20px; font-size: 20px; font-weight: 200; line-height: 1; color: white; display: block; padding: 8px 20px 12px; float: right;"></div>
                </div>
            </div>
        </div>

        <div class="container" id="content">
            <div class="content" id="body" style="">

            </div>

            <footer id="footer">
                <p>&copy; <a href="http://github.com/kersten">Kersten Burkhardt</a> &amp; <a href="http://github.com/volkerrichert">Volker Richert</a> 2011/2012 - <a href="/!/About" onclick="javascript:Backbone.history.navigate('!/About', true); return false;"><%- t('navigation.about') %></a></p>
                <div style="float: right; margin-top: -30px;" id="flattr">
                    <a class="FlattrButton"
                       style="display:none;"
                       title="VDR  GUIA"
                       data-flattr-uid="GOTTMODUS"
                       data-flattr-tags="software, opensource, GUIA, vdr, record, tvguide, program, tv"
                       data-flattr-category="software"
                       data-flattr-button="compact"
                       href="https://localhost:1443/"></a>
                    <noscript>
                        <a href="http://flattr.com/thing/095fbc870a68a6dcf5456d3e23ca6a7b/VDR-GUIA" target="_blank">
                            <img src="http://api.flattr.com/button/flattr-badge-large.png" alt="Flattr this" title="Flattr this" border="0" />
                        </a>
                    </noscript>
                </div>
            </footer>
        </div>
    </body>
</html>
